<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <!-- Bootstrap Font Icon CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous"/>
    <title>Selena - Simple Elevation Navigation</title>
    <style>
        img {
            border-radius: 50%;
        }
        .slidecontainer {
            width: 100%; /* Width of the outside container */
        }

        /* The slider itself */
        .slider {
        -webkit-appearance: none;  /* Override default CSS styles */
        appearance: none;
        width: 100%; /* Full-width */
        height: 15px; /* Specified height */
        background: #d3d3d3; /* Grey background */
        outline: none; /* Remove outline */
        opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
        -webkit-transition: .2s; /* 0.2 seconds transition on hover */
        transition: opacity .2s;
        }

        /* Mouse-over effects */
        .slider:hover {
        opacity: 1; /* Fully shown on mouse-over */
        }

        /* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
        .slider::-webkit-slider-thumb {
        -webkit-appearance: none; /* Override default look */
        appearance: none;
        width: 25px; /* Set a specific slider handle width */
        height: 25px; /* Slider handle height */
        background: #04AA6D; /* Green background */
        cursor: pointer; /* Cursor on hover */
        }

        .slider::-moz-range-thumb {
        width: 25px; /* Set a specific slider handle width */
        height: 25px; /* Slider handle height */
        background: #04AA6D; /* Green background */
        cursor: pointer; /* Cursor on hover */
        }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQIIBs6JaQjM3OViYfk_KpuKdnUGZTq-o&v=3.exp&sensor=false&libraries=places"></script>
    <script>
        function initialize() {
        var input = document.getElementById('searchTextField');
        new google.maps.places.Autocomplete(input);
        }
        function initialize2() {
        var input = document.getElementById('searchTextField2');
        new google.maps.places.Autocomplete(input);
        }

        google.maps.event.addDomListener(window, 'load', initialize);
        google.maps.event.addDomListener(window, 'load', initialize2);
    </script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  </head>
  <body class="bg-light">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <div class="container">
        <div class="py-4 text-center">
            <img class="mb-4 d-block mx-auto" src="logo.png" alt="Bootstrap Logo" width="150" height="150">
        </div>

    </div>
    
    <div class="container">
        <form novalidate>
            <div class="row g-1">
                <div class="row">
                    <div class="col-sm-3">
                        
                    </div>
                    <div class="col-sm-6">
                        <h4 class="mb-3">Location Information</h4>
                    </div>
            </div>
            <div class="row g-1 mb-3">
                <div class="col-sm-3">
                    
                </div>
                <div class="col-sm-6">
                    <label for="cityLocation" class="form-label">City</label>
                    <span class="bi bi-pin-map-fill"></span>
                    <select id="city" class="form-control">
                        <option value="default" selected disabled hidden>Select City</option>
                        <option value="Amherst">Amherst</option>
                        <option value="Boston">Boston</option>
                    </select>
                    <div class="invalid-feedback">Validate Entered Data</div>
                </div> 
            </div>
            <div class="row g-1 mb-3">
                <div class="col-sm-3">
                    
                </div>
                <div class="col-sm-6">
                    <label for="sourceLocation" class="form-label">Source</label>
                        <span class="bi bi-geo-alt-fill">
                        <input id="searchTextField" type="text" class="form-control" placeholder="Brandywine Dr, Amherst, MA, USA" required>
                    <div class="invalid-feedback">Validate Entered Data</div>
                </div>
            </div>
            <div class="row g-1 mb-3">
                <div class="col-sm-3">
                    
                </div>
                <div class="col-sm-6">
                    <label for="destionationLocation" class="form-label">Destination</label>
                    <span class="bi bi-geo-alt-fill"></span>
                    <input id="searchTextField2" type="text" class="form-control" placeholder="Rolling Green Dr, Amherst, MA, USA" required>
                    <div class="invalid-feedback">Validate Entered Data</div>
                </div> 
            </div>

            <div class="row g-1">
                <div class="row">
                    <div class="col-sm-3">
                        
                    </div>
                    <div class="col-sm-6">
                        <hr class="my-3">
                        <h4 class="mb-3">Algorithm Information</h4>
                    </div>
            </div>
            <div class="row g-1 mb-3">
                <div class="col-sm-3">
                    
                </div>
                <div class="col-sm-6">
                    <label for="algorithmType" class="form-label">Algorithm</label>
                    <span class="bi bi-bezier2"></span>
                    <select id="algorithm" class="form-control">
                        <option value="" selected disabled hidden>Select Algorithm</option>
                        <option value="Dijkstra">Dijkstra</option>
                        <option value="AStar">AStar</option>
                    </select>
                    <div class="invalid-feedback">Validate Entered Data</div>
                </div> 
           </div>
            <div class="row g-1">
                <div class="row">
                    <div class="col-sm-3">
                        
                    </div>
                    <div class="col-sm-4">
                        
                        <div class="slidecontainer">
                            <label for="elevation" class="form-label">Deviation Limit</label>
                            <span class="bi bi-graph-up"></span>
                            <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
                            <p>Value: <span id="demo"></span></p>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        
                        <div>
                            <label for="optimType" class="form-label">Optimisation Type</label>
                            <div class="btn-group" role="group" aria-label="Basic example">
                                <button type="button" class="btn btn-secondary" onclick="optimizerUpdate('min')">Min</button>
                                <button type="button" class="btn btn-secondary" onclick="optimizerUpdate('Regular')">Regular</button>
                                <button type="button" class="btn btn-secondary" onclick="optimizerUpdate('max')">Max</button>
                            </div>
                            <small class="text-muted">Regular - no elevation criteria</small>
                        </div>
                        
                    </div>
                    
            </div>
            <div class="row g-1">
                <div class="row">
                    <div class="col-sm-3">
                        
                    </div>
                    <div class="col-sm-6">
                        <hr class="my-3">
                    </div>
            </div>
        </form>

    </div>
    <div class="row text-center">
        <div class="col-sm-3">
            
        </div>
        <div class="col-sm-6 mb-2">
            <button type="button" class="btn btn-danger " value='Reset' name='reset' onclick="return resetForm(this.form);">   Reset Fields  </button>
            <button type="button" id="modal-activate" class="btn btn-primary"data-bs-toggle="modal" data-bs-target="#exampleModal">Generate Statistics</button>
            <button type="button" class="btn btn-success" onclick="visualiseMap()">Visualise Path on Map</button>
        </div>
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered modal-dialog-scrollable" style="width:1250px">
            <div class="modal-content" style="background:white">
                <div class="modal-header text-center bg-light">
                <h5 class="modal-title" id="exampleModalLabel">Elevation Path Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="div">Total Distance : <p id="distance"></p></div>
                        
                        <div >
                            Steepest incline : <p id="inclineSteep"></p> 
                        </div>
                        <div >
                            Elevation Gain : <p id="elevationGain"></p> 
                        </div>
                        <div >
                            Average Incline : <p id="inclineAvg"></p> 
                        </div>
                        Elevation Graph :
                        <div id="chart_div"></div>
                        
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        output.innerHTML = slider.value; // Display the default slider value

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
        output.innerHTML = this.value;
        }

        function resetForm(form) {
            // clearing inputs

            var inputs = form.getElementsByTagName('input');
            for (var i = 0; i<inputs.length; i++) {
                switch (inputs[i].type) {
                    // case 'hidden':
                    case 'text':
                        inputs[i].value = '';
                        break;
                    case 'radio':
                    case 'checkbox':
                        inputs[i].checked = false;   
                }
            }

            // clearing selects
            var selects = form.getElementsByTagName('select');
            for (var i = 0; i<selects.length; i++)
                selects[i].selectedIndex = 0;

            // clearing textarea
            var text= form.getElementsByTagName('textarea');
            for (var i = 0; i<text.length; i++)
                text[i].innerHTML= '';
            document.getElementById("distance").innerHTML = "";
            document.getElementById("inclineSteep").innerHTML = "";
            document.getElementById("elevationGain").innerHTML = "";
            document.getElementById("inclineAvg").innerHTML = "";
            drawChart([])
            return false;
        }

        optimizer="";
        
        function optimizerUpdate(val){
            optimizer=val;
            apiCall();
        }

        async function apiCall(){
            var city = document.getElementById("city").value;
            var source = document.getElementById("searchTextField").value;
            var destination = document.getElementById("searchTextField2").value;
            var algorithm = document.getElementById("algorithm").value;
            var deviation = parseInt(document.getElementById("myRange").value);
            const rawResponse = await fetch('http://127.0.0.1:5000/route', {
                method: 'POST',
                headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    
                    "algorithm": algorithm,
                    "start": source,
                    "dest": destination,
                    "mode": optimizer,
                    "limit": deviation,
                    "city": city
                    })
            });
            const content = await rawResponse.json();
            console.log("api call made");
            console.log(content);
            calculateStatistics(content);

        }

        function validate(){
            return (optimizer==="min" || optimizer==="max" ||optimizer==="Regular" ) && (document.getElementById("algorithm").value ==="Dijkstra" || document.getElementById("algorithm").value === "AStar") && document.getElementById("searchTextField").value.includes(document.getElementById("city").value) && document.getElementById("searchTextField2").value.includes(document.getElementById("city").value);
        }

        function visualiseMap(){
            if(validate()){
                // calculateStatistics();
                var city = document.getElementById("city").value;
                var source = document.getElementById("searchTextField").value;
                var destination = document.getElementById("searchTextField2").value;
                var algorithm = document.getElementById("algorithm").value;
                var deviation = document.getElementById("myRange").value;
                console.log("?city="+city+"&source="+source+"&destination="+destination+"&algorithm="+algorithm+"&deviation="+deviation+"&optim="+optimizer);
                window.open('view_route.html'+"?city="+city+"&source="+source+"&destination="+destination+"&algorithm="+algorithm+"&deviation="+deviation+"&optim="+optimizer,'_blank');
            }
            else{
                alert("The source or destination does not match the selected city");
            }
        }


        function calculateStatistics(pathInfo){
//             var pathInfo = {
//     "path": [
//         [
//             -72.5340336,
//             42.3065024
//         ],
//         [
//             -72.529507,
//             42.305842
//         ],
//         [
//             -72.530835,
//             42.314102
//         ],
//         [
//             -72.5302102,
//             42.3162496
//         ],
//         [
//             -72.5290128,
//             42.318066
//         ],
//         [
//             -72.5276673,
//             42.3186634
//         ],
//         [
//             -72.5273994,
//             42.318737
//         ],
//         [
//             -72.5263526,
//             42.3191833
//         ],
//         [
//             -72.526089,
//             42.3192102
//         ],
//         [
//             -72.5259943,
//             42.319436
//         ],
//         [
//             -72.5257466,
//             42.3202211
//         ],
//         [
//             -72.524846,
//             42.3225177
//         ],
//         [
//             -72.524758,
//             42.32331
//         ],
//         [
//             -72.523569,
//             42.332674
//         ],
//         [
//             -72.523375,
//             42.334335
//         ],
//         [
//             -72.521312,
//             42.337956
//         ],
//         [
//             -72.520176,
//             42.340028
//         ],
//         [
//             -72.516127,
//             42.340087
//         ],
//         [
//             -72.514235,
//             42.340124
//         ],
//         [
//             -72.513206,
//             42.340141
//         ],
//         [
//             -72.5097413,
//             42.3402215
//         ],
//         [
//             -72.504612,
//             42.340307
//         ],
//         [
//             -72.504604,
//             42.340729
//         ],
//         [
//             -72.504608,
//             42.341084
//         ],
//         [
//             -72.504628,
//             42.342192
//         ],
//         [
//             -72.5043174,
//             42.3432864
//         ],
//         [
//             -72.5041533,
//             42.3469954
//         ],
//         [
//             -72.5041924,
//             42.3507494
//         ],
//         [
//             -72.5044974,
//             42.3565354
//         ],
//         [
//             -72.5035754,
//             42.3639034
//         ],
//         [
//             -72.499263,
//             42.363022
//         ],
//         [
//             -72.498899,
//             42.364389
//         ],
//         [
//             -72.496316,
//             42.363813
//         ],
//         [
//             -72.492426,
//             42.366246
//         ],
//         [
//             -72.4897726,
//             42.3641006
//         ],
//         [
//             -72.4890161,
//             42.3632273
//         ],
//         [
//             -72.488204,
//             42.36229
//         ],
//         [
//             -72.487822,
//             42.361811
//         ],
//         [
//             -72.4876506,
//             42.3616022
//         ],
//         [
//             -72.4874536,
//             42.3618492
//         ],
//         [
//             -72.485007,
//             42.362391
//         ]
//     ],
//     "path_data": [
//         {
//             "elevation": 163.306,
//             "grade": 0,
//             "length": 402.95700000000005
//         },
//         {
//             "elevation": 158.767,
//             "grade": 0,
//             "length": 979.5079999999999
//         },
//         {
//             "elevation": 89.973,
//             "grade": 0,
//             "length": 244.59300000000002
//         },
//         {
//             "elevation": 82.675,
//             "grade": 0.001,
//             "length": 230.169
//         },
//         {
//             "elevation": 82.943,
//             "grade": 0,
//             "length": 129.88
//         },
//         {
//             "elevation": 78.947,
//             "grade": 0,
//             "length": 24.718
//         },
//         {
//             "elevation": 78.405,
//             "grade": 0,
//             "length": 100.363
//         },
//         {
//             "elevation": 74.55,
//             "grade": 0,
//             "length": 22.790999999999997
//         },
//         {
//             "elevation": 73.915,
//             "grade": 0,
//             "length": 27.968
//         },
//         {
//             "elevation": 72.255,
//             "grade": 0,
//             "length": 89.679
//         },
//         {
//             "elevation": 71.149,
//             "grade": 0,
//             "length": 268.15700000000004
//         },
//         {
//             "elevation": 63.032,
//             "grade": 0,
//             "length": 88.396
//         },
//         {
//             "elevation": 61.902,
//             "grade": 0,
//             "length": 1045.965
//         },
//         {
//             "elevation": 58.089,
//             "grade": 0,
//             "length": 185.382
//         },
//         {
//             "elevation": 56.709,
//             "grade": 0,
//             "length": 440.97700000000003
//         },
//         {
//             "elevation": 48.948,
//             "grade": 0.003,
//             "length": 248.958
//         },
//         {
//             "elevation": 49.797,
//             "grade": 0.002,
//             "length": 332.88300000000004
//         },
//         {
//             "elevation": 50.371,
//             "grade": 0,
//             "length": 155.561
//         },
//         {
//             "elevation": 48.519,
//             "grade": 0.001,
//             "length": 84.595
//         },
//         {
//             "elevation": 48.581,
//             "grade": 0.008,
//             "length": 284.973
//         },
//         {
//             "elevation": 50.894,
//             "grade": 0.045,
//             "length": 421.721
//         },
//         {
//             "elevation": 69.78,
//             "grade": 0.003,
//             "length": 46.929
//         },
//         {
//             "elevation": 69.926,
//             "grade": 0,
//             "length": 39.476
//         },
//         {
//             "elevation": 69.239,
//             "grade": 0,
//             "length": 123.215
//         },
//         {
//             "elevation": 66.617,
//             "grade": 0,
//             "length": 124.593
//         },
//         {
//             "elevation": 63.222,
//             "grade": 0,
//             "length": 412.71500000000003
//         },
//         {
//             "elevation": 61.535,
//             "grade": 0,
//             "length": 418.01
//         },
//         {
//             "elevation": 59.412,
//             "grade": 0,
//             "length": 644.736
//         },
//         {
//             "elevation": 55.214,
//             "grade": 0,
//             "length": 823.741
//         },
//         {
//             "elevation": 53.941,
//             "grade": 0,
//             "length": 367.617
//         },
//         {
//             "elevation": 51.169,
//             "grade": 0.007,
//             "length": 155.87099999999998
//         },
//         {
//             "elevation": 52.244,
//             "grade": 0,
//             "length": 235.498
//         },
//         {
//             "elevation": 51.798,
//             "grade": 0.002,
//             "length": 418.863
//         },
//         {
//             "elevation": 52.551,
//             "grade": 0,
//             "length": 323.2459999999999
//         },
//         {
//             "elevation": 49.602,
//             "grade": 0.031,
//             "length": 115.803
//         },
//         {
//             "elevation": 53.196,
//             "grade": 0.027,
//             "length": 123.755
//         },
//         {
//             "elevation": 56.518,
//             "grade": 0.017,
//             "length": 61.822
//         },
//         {
//             "elevation": 57.545,
//             "grade": 0.012,
//             "length": 27.157
//         },
//         {
//             "elevation": 57.881,
//             "grade": 0.005,
//             "length": 31.880000000000003
//         },
//         {
//             "elevation": 58.048,
//             "grade": 0.038,
//             "length": 213.68900000000002
//         },
//         {
//             "elevation": 66.086,
//             "length": 0
//         }
//     ]
// }
        console.log(pathInfo);
        let datas = [];
        let finalDistance = 0;
        let maxGrade = 0;
        let averageGrade = 0;
        let totalElevationGain = 0;
        let path = pathInfo.path;
        let path_data = pathInfo.path_data;

        let label = [];
        let elevData = [];
        let total_Dist = 0;
        maxGrade = 0;
        for (let i = 0; i < path.length; i++) {

            let long = path[i][0];
            let lat = path[i][1];
            let dist = path_data[i].length;
            let grade = path_data[i].grade;
            let elev = path_data[i].elevation;

            total_Dist += dist;
            if (grade > maxGrade) {
                maxGrade = grade;
            }

            if (i !== path.length - 1) {
                averageGrade += grade;
                if ((path_data[i+1].elevation - elev) > 0){
                    totalElevationGain += (path_data[i+1].elevation - elev);
                }
            }
            

            label.push(lat + ", " + long);
            elevData.push([i+1, elev]);
        }

        averageGrade /= path.length;
        finalDistance = total_Dist;
        document.getElementById("distance").innerHTML = (finalDistance/1000).toFixed(3) + " Kilometers";
        document.getElementById("inclineSteep").innerHTML = (maxGrade * 10).toFixed(3) + " Vertical Meters per 10 Meters";
        document.getElementById("elevationGain").innerHTML = totalElevationGain+ " Meters";
        document.getElementById("inclineAvg").innerHTML = (averageGrade * 10).toFixed(3) + " Vertical Meters per 10 Meters";

        // console.log("Total Distance = " + (finalDistance/1000).toFixed(3) + " Kilometers");
        // console.log("steepest incline = " + (maxGrade * 10).toFixed(3) + " Meters");
        // console.log("Total elevation gain = " + totalElevationGain+ " Meters")
        // console.log("Average Incline = " + (averageGrade * 10).toFixed(3) + " Vertical Meters per 10 Meters");
        drawChart(elevData);
    }
    
    </script>
    <script>
        google.charts.load('current', {packages: ['corechart', 'line']});

        function drawChart(elevationData) {

            var data = new google.visualization.DataTable();
            data.addColumn('number', 'X');
            data.addColumn('number', 'Height');

            data.addRows(elevationData);

            var options = {
                hAxis: {
                    title: 'Path Nodes',
                    
                },
                vAxis: {
                    title: 'Elevation'
                },
                'width':430,
                'height':300
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

            chart.draw(data, options);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js" integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous"></script>
  </body>
</html>